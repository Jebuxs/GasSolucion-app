<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasSoluci√≥n | Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @keyframes loading-bar { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }
        .animate-progress { animation: loading-bar 2s infinite ease-in-out; }
        #map-rastreo { height: 280px; width: 100%; border-radius: 2.5rem; z-index: 1; }
        .leaflet-control-attribution { display: none !important; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col relative overflow-hidden">
        
        <div id="pantalla-inicio" class="flex-1 flex flex-col p-8 justify-center items-center text-center space-y-8 animate-in fade-in duration-500">
            <div class="space-y-2">
                <div class="bg-red-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-xl mb-4 text-4xl shadow-red-200">üî•</div>
                <h1 class="text-4xl font-black tracking-tighter uppercase italic">GasSoluci√≥n</h1>
                <p class="text-slate-400 font-medium italic tracking-tight">Hola, <span id="u-nombre-inicio" class="text-slate-900 font-black uppercase tracking-normal">...</span></p>
            </div>
            <div class="grid grid-cols-1 gap-4 w-full">
                <button onclick="irAFormulario('ahora')" class="p-6 bg-slate-900 rounded-[2.5rem] text-left active:scale-95 shadow-2xl transition-all border-b-4 border-slate-700">
                    <span class="text-3xl">üöÄ</span>
                    <h2 class="text-white text-xl font-black uppercase mt-2">Solicitar Ahora</h2>
                    <p class="text-slate-400 text-xs font-bold tracking-tight">Entrega r√°pida en tu ubicaci√≥n.</p>
                </button>
                <button onclick="irAFormulario('planificado')" class="p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] text-left active:scale-95 shadow-lg transition-all border-b-4 border-slate-200">
                    <span class="text-3xl">üóìÔ∏è</span>
                    <h2 class="text-slate-900 text-xl font-black uppercase mt-2">Planificar Compra</h2>
                    <p class="text-slate-400 text-xs font-bold tracking-tight">Agenda para otro d√≠a u hora.</p>
                </button>
            </div>
            <button onclick="cerrarSesion()" class="text-slate-300 font-bold text-[10px] uppercase tracking-widest hover:text-red-600">Cerrar Sesi√≥n</button>
        </div>

        <div id="pantalla-formulario" class="hidden flex-1 flex flex-col overflow-y-auto animate-in slide-in-from-right duration-300">
            <div class="p-6 pb-2 flex justify-between items-center sticky top-0 bg-white/80 backdrop-blur-md z-20">
                <button onclick="regresarInicio()" class="text-slate-400 font-black text-xl bg-slate-100 w-10 h-10 rounded-full">‚úï</button>
                <h2 id="txt-modo-nav" class="text-[10px] font-black uppercase tracking-widest text-red-600 tracking-tighter">Configurar Pedido</h2>
                <div class="w-10"></div>
            </div>
            
            <div class="px-6 mb-4"><div id="map" class="h-44 rounded-[2.5rem] border-4 border-slate-50 shadow-inner z-10"></div></div>

            <div class="px-6 space-y-4 pb-40">
                <div id="campo-fecha" class="hidden bg-blue-50 p-5 rounded-[2.5rem] border border-blue-100">
                    <p class="text-[10px] font-black text-blue-600 uppercase mb-2 ml-2 tracking-widest">¬øPara cu√°ndo lo necesitas?</p>
                    <input type="datetime-local" id="f-fecha" class="w-full bg-white p-4 rounded-2xl border-2 border-blue-100 font-bold text-slate-700 outline-none">
                </div>

                <div class="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-dom" class="w-6 h-6 rounded-lg accent-red-600" checked>
                        <label for="check-dom" class="font-black text-[10px] uppercase text-slate-400 tracking-widest">Gas Dom√©stico</label>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center"><p class="text-[7px] font-black text-yellow-600 mb-1">AMA</p><input type="number" id="cd-ama" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                        <div class="text-center"><p class="text-[7px] font-black text-blue-600 mb-1">AZU</p><input type="number" id="cd-azu" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                        <div class="text-center"><p class="text-[7px] font-black text-orange-600 mb-1">NAR</p><input type="number" id="cd-nar" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                    </div>
                </div>

                <div class="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-ind" class="w-6 h-6 rounded-lg accent-red-600">
                        <label for="check-ind" class="font-black text-[10px] uppercase text-slate-400 tracking-widest">Gas Industrial</label>
                    </div>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="text-center"><p class="text-[7px] font-black text-yellow-600 mb-1">AMA</p><input type="number" id="ci-ama" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                        <div class="text-center"><p class="text-[7px] font-black text-blue-600 mb-1">AZU</p><input type="number" id="ci-azu" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                        <div class="text-center"><p class="text-[7px] font-black text-orange-600 mb-1">NAR</p><input type="number" id="ci-nar" placeholder="0" class="bg-white w-full p-4 rounded-2xl border-2 border-slate-200 text-center font-bold text-lg"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-red-50 p-6 rounded-[2.5rem] border border-red-100">
                    <span class="font-black text-red-600 text-[10px] uppercase tracking-widest italic">üí∞ Propina</span>
                    <input type="number" id="f-propina" value="0" class="w-20 bg-white p-3 rounded-2xl border-2 border-red-200 text-center font-black text-red-600">
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white to-transparent z-30">
                <button id="btn-main" onclick="realizarPedido()" class="w-full p-6 rounded-[2.5rem] font-black text-xl bg-red-600 text-white shadow-2xl active:scale-95 transition-all">CONFIRMAR PEDIDO</button>
            </div>
        </div>

        <div id="pantalla-estado" class="hidden flex-1 flex flex-col p-6 overflow-y-auto animate-in fade-in">
            <div class="text-center mb-6">
                <div id="indicador-busqueda" class="space-y-4">
                    <div class="relative mx-auto w-24 h-24">
                        <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                        <div class="absolute inset-0 border-4 border-red-600 rounded-full border-t-transparent animate-spin"></div>
                        <div class="absolute inset-0 flex items-center justify-center text-3xl">üöö</div>
                    </div>
                    <h2 class="text-2xl font-black uppercase tracking-tighter">Buscando Proveedor...</h2>
                    <div class="w-full bg-slate-100 h-2 rounded-full overflow-hidden">
                        <div class="bg-red-600 h-full animate-progress"></div>
                    </div>
                </div>
                <div id="indicador-en-camino" class="hidden space-y-2">
                    <h2 class="text-3xl font-black text-green-600 uppercase italic tracking-tighter">Repartidor en camino</h2>
                </div>
            </div>
            <div class="bg-slate-100 rounded-[2.5rem] overflow-hidden mb-6 shadow-xl relative border-4 border-white"><div id="map-rastreo"></div></div>
            <div class="bg-slate-50 p-6 rounded-[2.5rem] border border-slate-100 mb-6 space-y-4">
                <div id="info-repartidor" class="hidden flex items-center gap-4 border-b border-slate-200 pb-4">
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-xl shadow-inner">üë§</div>
                    <div><p class="text-[9px] font-black text-slate-400 uppercase">Distribuidor</p><p id="nombre-rep" class="font-black text-lg text-slate-900 leading-none lowercase uppercase tracking-tighter">...</p></div>
                </div>
                <div id="resumen-items" class="text-xs font-bold text-slate-500 italic leading-tight uppercase tracking-tighter"></div>
            </div>
            <button id="btn-cancelar" class="w-full p-5 rounded-[2rem] border-2 border-slate-100 text-slate-300 font-black uppercase text-[10px] tracking-widest">Anular Pedido</button>
        </div>

        <div id="pantalla-confirmacion" class="hidden flex-1 flex flex-col p-8 justify-center items-center text-center space-y-8 animate-in zoom-in duration-500">
            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-5xl shadow-inner animate-bounce">‚úÖ</div>
            <div class="space-y-2">
                <h2 class="text-4xl font-black uppercase tracking-tighter text-slate-900 leading-none italic">¬øGas Recibido?</h2>
                <p class="text-slate-400 font-medium italic">Confirma si el repartidor te entreg√≥ los tanques correctamente.</p>
            </div>
            <div class="w-full space-y-4">
                <button id="btn-confirmar-entrega" class="w-full p-7 bg-green-600 text-white rounded-[2.5rem] font-black text-2xl shadow-2xl active:scale-95 transition-all shadow-green-200 uppercase tracking-tighter">
                    S√ç, RECIBIDO
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWGkvNQHt7URcoP2risWMBfYtdV1Un7Sk",
            authDomain: "gassolucion.firebaseapp.com",
            projectId: "gassolucion",
            storageBucket: "gassolucion.firebasestorage.app",
            messagingSenderId: "948928136223",
            appId: "1:948928136223:web:06bb3d6bf8054c1be0c12a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, marker, mapRastreo, markerCliente, markerRepartidor;
        let userGlobal = null;
        let modoActual = "ahora";

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else { 
                userGlobal = user; 
                document.getElementById('u-nombre-inicio').innerText = user.displayName ? user.displayName.split(' ')[0] : "Amigo";
                escucharPedidos(); 
            }
        });

        window.irAFormulario = (m) => {
            modoActual = m;
            document.getElementById('pantalla-inicio').classList.add('hidden');
            document.getElementById('pantalla-formulario').classList.remove('hidden');
            document.getElementById('campo-fecha').classList.toggle('hidden', m === 'ahora');
            document.getElementById('txt-modo-nav').innerText = m === 'ahora' ? 'Entrega Inmediata' : 'Planificar Compra';
            setTimeout(() => initMap(), 300);
        };

        window.regresarInicio = () => {
            document.getElementById('pantalla-inicio').classList.remove('hidden');
            document.getElementById('pantalla-formulario').classList.add('hidden');
        };

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([-0.1807, -78.4678], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([-0.1807, -78.4678], {draggable: true}).addTo(map);
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.on('locationfound', e => marker.setLatLng(e.latlng));
        }

        window.realizarPedido = async function() {
            const btn = document.getElementById('btn-main');
            const pos = marker.getLatLng();
            btn.disabled = true; btn.innerText = "PROCESANDO...";

            try {
                const pedido = {
                    uidC: userGlobal.uid,
                    nombre: userGlobal.displayName || "Cliente",
                    lat: pos.lat, lng: pos.lng,
                    estado: 'pendiente',
                    modo: modoActual,
                    propina: document.getElementById('f-propina').value || 0,
                    fechaPlan: modoActual === 'planificado' ? document.getElementById('f-fecha').value : 'inmediato',
                    fechaCrea: new Date().toISOString(),
                    items: []
                };

                const conf = [
                    {id:'cd-ama', t:'Dom', c:'Amarillo', chk:'check-dom'}, {id:'cd-azu', t:'Dom', c:'Azul', chk:'check-dom'}, {id:'cd-nar', t:'Dom', c:'Naranja', chk:'check-dom'},
                    {id:'ci-ama', t:'Ind', c:'Amarillo', chk:'check-ind'}, {id:'ci-azu', t:'Ind', c:'Azul', chk:'check-ind'}, {id:'ci-nar', t:'Ind', c:'Naranja', chk:'check-ind'}
                ];

                conf.forEach(i => {
                    const el = document.getElementById(i.id);
                    const val = el && el.value ? parseInt(el.value) : 0;
                    const checkbox = document.getElementById(i.chk);
                    if (val > 0 && checkbox && checkbox.checked) pedido.items.push({n: val, t: i.t, c: i.c});
                });

                if (pedido.items.length === 0) {
                    alert("‚ö†Ô∏è Selecciona cantidad y marca el tipo de gas."); 
                    btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO"; return;
                }

                await addDoc(collection(db, "pedidos"), pedido);
                // Cambio inmediato para evitar que el bot√≥n se quede pegado
                document.getElementById('pantalla-formulario').classList.add('hidden');
                document.getElementById('pantalla-estado').classList.remove('hidden');

            } catch (e) { alert("Error: " + e.message); btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO"; }
        };

        function escucharPedidos() {
            const q = query(collection(db, "pedidos"), where("uidC", "==", auth.currentUser.uid));
            onSnapshot(q, async (snap) => {
                const pE = document.getElementById('pantalla-estado');
                const pI = document.getElementById('pantalla-inicio');
                const pF = document.getElementById('pantalla-formulario');
                const pC = document.getElementById('pantalla-confirmacion');

                if (!snap.empty) {
                    const docRef = snap.docs[0];
                    const data = docRef.data();
                    const id = docRef.id;

                    // L√ìGICA DE CONFIRMACI√ìN OBLIGATORIA
                    if (data.estado === 'finalizado') {
                        pI.classList.add('hidden'); pF.classList.add('hidden'); pE.classList.add('hidden');
                        pC.classList.remove('hidden');
                        document.getElementById('btn-confirmar-entrega').onclick = async () => {
                            await deleteDoc(doc(db, "pedidos", id));
                            pC.classList.add('hidden');
                        };
                        return;
                    }

                    pI.classList.add('hidden'); pF.classList.add('hidden'); pC.classList.add('hidden');
                    pE.classList.remove('hidden');

                    if (data.estado === 'aceptado') {
                        document.getElementById('indicador-busqueda').classList.add('hidden');
                        document.getElementById('indicador-en-camino').classList.remove('hidden');
                        document.getElementById('info-repartidor').classList.remove('hidden');
                        document.getElementById('nombre-rep').innerText = data.nombreR || "Repartidor";
                        initMapRastreo(data.lat, data.lng, data.latR, data.lngR);
                    } else {
                        document.getElementById('indicador-busqueda').classList.remove('hidden');
                        document.getElementById('indicador-en-camino').classList.add('hidden');
                        document.getElementById('info-repartidor').classList.add('hidden');
                        initMapRastreo(data.lat, data.lng, null, null);
                    }
                    document.getElementById('resumen-items').innerText = "Pedido: " + data.items.map(i => `${i.n} ${i.t} ${i.c}`).join(', ');
                    document.getElementById('btn-cancelar').onclick = () => { if(confirm("¬øAnular pedido?")) deleteDoc(doc(db, "pedidos", id)); };
                } else {
                    pE.classList.add('hidden'); pC.classList.add('hidden'); pF.classList.add('hidden');
                    pI.classList.remove('hidden');
                    mapRastreo = null; 
                }
            });
        }

        function initMapRastreo(latC, lngC, latR, lngR) {
            if (!mapRastreo) {
                mapRastreo = L.map('map-rastreo', { zoomControl: false }).setView([latC, lngC], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapRastreo);
                markerCliente = L.circleMarker([latC, lngC], {color: '#ef4444', radius: 10, fillOpacity: 0.8}).addTo(mapRastreo);
                markerRepartidor = L.marker([latR || latC, lngR || lngC], {
                    icon: L.divIcon({ html: '<div class="text-3xl">üöö</div>', className: 'truck-icon', iconSize: [40, 40] })
                }).addTo(mapRastreo);
            }
            markerCliente.setLatLng([latC, lngC]);
            if (latR && lngR) {
                markerRepartidor.setLatLng([latR, lngR]);
                mapRastreo.fitBounds(L.latLngBounds([latC, lngC], [latR, lngR]), {padding: [50, 50]});
            }
        }

        window.cerrarSesion = () => signOut(auth).then(() => window.location.href = "index.html");
    </script>
</body>
</html>
