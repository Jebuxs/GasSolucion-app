<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasSoluci√≥n | Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @keyframes loading-bar {
            0% { width: 0%; }
            50% { width: 70%; }
            100% { width: 100%; }
        }
        .animate-progress { animation: loading-bar 2s infinite ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col relative overflow-hidden">
        
        <div id="pantalla-inicio" class="flex-1 flex flex-col p-8 justify-center items-center text-center space-y-8">
            <div class="space-y-2">
                <div class="bg-red-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-xl mb-4 text-4xl">üî•</div>
                <h1 class="text-4xl font-black tracking-tighter">GasSoluci√≥n</h1>
                <p class="text-slate-400 font-medium">Hola, <span id="u-nombre-inicio" class="text-slate-900 font-bold">...</span></p>
            </div>
            <div class="grid grid-cols-1 gap-4 w-full">
                <button onclick="irAFormulario('ahora')" class="p-6 bg-slate-900 rounded-[2.5rem] text-left active:scale-95 shadow-2xl transition-all">
                    <span class="text-3xl">üöÄ</span>
                    <h2 class="text-white text-xl font-black uppercase mt-2">Solicitar Ahora</h2>
                    <p class="text-slate-400 text-xs">Entrega inmediata en tu ubicaci√≥n.</p>
                </button>
                <button onclick="irAFormulario('planificado')" class="p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] text-left active:scale-95 shadow-lg transition-all">
                    <span class="text-3xl">üóìÔ∏è</span>
                    <h2 class="text-slate-900 text-xl font-black uppercase mt-2">Planificar Compra</h2>
                    <p class="text-slate-400 text-xs">Agenda para otro d√≠a u hora.</p>
                </button>
            </div>
            <button onclick="cerrarSesion()" class="text-slate-300 font-bold text-[10px] uppercase tracking-widest">Cerrar Sesi√≥n</button>
        </div>

        <div id="pantalla-formulario" class="hidden flex-1 flex flex-col overflow-y-auto">
            <div class="p-6 pb-2 flex justify-between items-center sticky top-0 bg-white z-20">
                <button onclick="regresarInicio()" class="text-slate-400 font-bold">‚Üê</button>
                <h2 id="titulo-modo" class="text-[10px] font-black uppercase tracking-widest text-red-600 text-center">Configurar Pedido</h2>
                <div class="w-4"></div>
            </div>
            <div class="px-6 mb-4"><div id="map" class="h-44 rounded-[2.5rem] border-4 border-slate-50 shadow-inner"></div></div>
            <div class="px-6 space-y-4 pb-32">
                <div id="campo-fecha" class="hidden bg-blue-50 p-5 rounded-[2rem] border border-blue-100">
                    <p class="text-[9px] font-black text-blue-600 uppercase mb-2">Fecha y Hora de Entrega</p>
                    <input type="datetime-local" id="f-fecha" class="w-full bg-white p-3 rounded-xl border-2 border-blue-100 font-bold">
                </div>
                <div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-dom" class="w-6 h-6 rounded-lg accent-red-600">
                        <label for="check-dom" class="font-black text-xs uppercase text-slate-400 tracking-widest">Dom√©stico</label>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="cd-ama" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                        <input type="number" id="cd-azu" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                        <input type="number" id="cd-nar" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                    </div>
                </div>
                <div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-ind" class="w-6 h-6 rounded-lg accent-red-600">
                        <label for="check-ind" class="font-black text-xs uppercase text-slate-400 tracking-widest">Industrial</label>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="ci-ama" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                        <input type="number" id="ci-azu" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                        <input type="number" id="ci-nar" value="0" onfocus="if(this.value=='0')this.value=''" class="bg-white p-3 rounded-xl border-2 border-slate-200 text-center font-bold">
                    </div>
                </div>
                <div class="flex justify-between items-center bg-red-50 p-5 rounded-[2rem] border border-red-100">
                    <span class="font-black text-red-600 text-xs uppercase tracking-widest">üí∞ Propina $</span>
                    <input type="number" id="f-propina" value="0" onfocus="if(this.value=='0')this.value=''" class="w-20 bg-white p-2 rounded-xl border-2 border-red-200 text-center font-black">
                </div>
            </div>
            <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white to-transparent">
                <button id="btn-main" onclick="realizarPedido()" class="w-full p-6 rounded-[2.5rem] font-black text-xl bg-red-600 text-white shadow-2xl active:scale-95 transition-all">CONFIRMAR PEDIDO</button>
            </div>
        </div>

        <div id="pantalla-estado" class="hidden flex-1 flex flex-col p-8 justify-center items-center text-center">
            <div class="w-full space-y-8">
                <div class="relative mx-auto w-32 h-32">
                    <div class="absolute inset-0 border-8 border-slate-100 rounded-full"></div>
                    <div class="absolute inset-0 border-8 border-red-600 rounded-full border-t-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center text-4xl">üöö</div>
                </div>
                <div class="space-y-2">
                    <h2 id="estado-titulo" class="text-3xl font-black tracking-tighter uppercase">Buscando...</h2>
                    <p class="text-slate-400 text-sm font-medium">Estamos conectando con el distribuidor m√°s cercano a Llano Chico.</p>
                </div>
                <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden border border-slate-200">
                    <div class="bg-red-600 h-full animate-progress rounded-full"></div>
                </div>
                <div id="resumen-pedido" class="bg-slate-50 p-6 rounded-[2.5rem] text-left border border-slate-100">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Tu pedido:</p>
                    <div id="resumen-items" class="space-y-1 font-bold text-slate-700"></div>
                </div>
                <button id="btn-cancelar" class="w-full p-6 rounded-[2.5rem] border-2 border-slate-100 text-slate-400 font-black uppercase text-sm">Anular Pedido</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWGkvNQHt7URcoP2risWMBfYtdV1Un7Sk",
            authDomain: "gassolucion.firebaseapp.com",
            projectId: "gassolucion",
            storageBucket: "gassolucion.firebasestorage.app",
            messagingSenderId: "948928136223",
            appId: "1:948928136223:web:06bb3d6bf8054c1be0c12a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, marker, userGlobal = null;
        let modoActual = "ahora";

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else {
                userGlobal = user;
                document.getElementById('u-nombre-inicio').innerText = user.displayName.split(' ')[0];
                escucharPedidos();
            }
        });

        window.irAFormulario = (modo) => {
            modoActual = modo;
            document.getElementById('pantalla-inicio').classList.add('hidden');
            document.getElementById('pantalla-formulario').classList.remove('hidden');
            document.getElementById('campo-fecha').classList.toggle('hidden', modo === 'ahora');
            setTimeout(() => { initMap(); }, 300);
        };

        window.regresarInicio = () => {
            document.getElementById('pantalla-inicio').classList.remove('hidden');
            document.getElementById('pantalla-formulario').classList.add('hidden');
        };

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([-0.1807, -78.4678], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([-0.1807, -78.4678], {draggable: true}).addTo(map);
            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.on('locationfound', (e) => marker.setLatLng(e.latlng));
        }

        window.realizarPedido = async function() {
            const btn = document.getElementById('btn-main');
            const pos = marker.getLatLng();
            btn.disabled = true; btn.innerText = "ENVIANDO...";

            const pedido = {
                uidC: userGlobal.uid,
                nombre: userGlobal.displayName,
                lat: pos.lat, lng: pos.lng,
                propina: document.getElementById('f-propina').value || 0,
                estado: 'pendiente',
                modo: modoActual,
                items: [],
                fecha: new Date().toISOString()
            };

            const config = [
                {id:'cd-ama', t:'Dom√©stico', c:'Amarillo', chk:'check-dom'}, {id:'cd-azu', t:'Dom√©stico', c:'Azul', chk:'check-dom'}, {id:'cd-nar', t:'Dom√©stico', c:'Naranja', chk:'check-dom'},
                {id:'ci-ama', t:'Industrial', c:'Amarillo', chk:'check-ind'}, {id:'ci-azu', t:'Industrial', c:'Azul', chk:'check-ind'}, {id:'ci-nar', t:'Industrial', c:'Naranja', chk:'check-ind'}
            ];

            config.forEach(i => {
                const n = parseInt(document.getElementById(i.id).value);
                if (n > 0 && document.getElementById(i.chk).checked) pedido.items.push({n, t:i.t, c:i.c});
            });

            if (pedido.items.length === 0) {
                alert("Selecciona cantidades"); btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO"; return;
            }

            try {
                await addDoc(collection(db, "pedidos"), pedido);
                // La pantalla cambia sola gracias a escucharPedidos()
            } catch (e) { alert(e.message); btn.disabled = false; }
        };

        function escucharPedidos() {
            const q = query(collection(db, "pedidos"), where("uidC", "==", auth.currentUser.uid));
            onSnapshot(q, snap => {
                const pI = document.getElementById('pantalla-inicio');
                const pF = document.getElementById('pantalla-formulario');
                const pE = document.getElementById('pantalla-estado');

                if (!snap.empty) {
                    const ped = snap.docs[0];
                    const data = ped.data();
                    pI.classList.add('hidden');
                    pF.classList.add('hidden');
                    pE.classList.remove('hidden');

                    document.getElementById('estado-titulo').innerText = data.estado === 'pendiente' ? "Buscando..." : "¬°En camino!";
                    document.getElementById('resumen-items').innerHTML = data.items.map(i => `<div>‚Ä¢ ${i.n} ${i.t} (${i.c})</div>`).join('');
                    
                    document.getElementById('btn-cancelar').onclick = () => {
                        if(confirm("¬øAnular pedido?")) deleteDoc(doc(db, "pedidos", ped.id));
                    };
                } else {
                    pE.classList.add('hidden');
                    pI.classList.remove('hidden'); // Solo vuelve al inicio si no hay pedido
                }
            });
        }

        window.cerrarSesion = () => signOut(auth).then(() => window.location.href = "index.html");
    </script>
</body>
</html>
