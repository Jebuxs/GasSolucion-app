<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasSoluci√≥n | Cliente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans text-slate-900">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col relative overflow-hidden">
        
        <div id="pantalla-inicio" class="flex-1 flex flex-col p-8 justify-center items-center text-center space-y-8 animate-in fade-in duration-500">
            <div class="space-y-2">
                <div class="bg-red-600 w-20 h-20 rounded-[2.5rem] flex items-center justify-center mx-auto shadow-xl shadow-red-200 mb-4">
                    <span class="text-4xl">üî•</span>
                </div>
                <h1 class="text-4xl font-black tracking-tighter">GasSoluci√≥n</h1>
                <p class="text-slate-400 font-medium italic">¬øQu√© necesitas hoy, <span id="u-nombre-inicio" class="text-slate-900">...</span>?</p>
            </div>

            <div class="grid grid-cols-1 gap-4 w-full">
                <button onclick="irAFormulario('ahora')" class="group p-6 bg-slate-900 rounded-[2.5rem] text-left transition-all active:scale-95 shadow-2xl shadow-slate-200 border-b-4 border-slate-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-3xl">üöÄ</span>
                        <span class="bg-red-600 text-[9px] font-black text-white px-3 py-1 rounded-full uppercase tracking-widest">Inmediato</span>
                    </div>
                    <h2 class="text-white text-xl font-black uppercase tracking-tight">Solicitar Gas</h2>
                    <p class="text-slate-400 text-xs">Entrega r√°pida en tu ubicaci√≥n actual.</p>
                </button>

                <button onclick="irAFormulario('planificado')" class="group p-6 bg-white border-2 border-slate-100 rounded-[2.5rem] text-left transition-all active:scale-95 shadow-lg shadow-slate-100 border-b-4 border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-3xl">üóìÔ∏è</span>
                    </div>
                    <h2 class="text-slate-900 text-xl font-black uppercase tracking-tight">Planificar Compra</h2>
                    <p class="text-slate-400 text-xs">Agenda tu pedido para otra fecha u hora.</p>
                </button>
            </div>

            <button onclick="cerrarSesion()" class="text-slate-400 font-bold text-[10px] uppercase tracking-widest">Cerrar Sesi√≥n</button>
        </div>

        <div id="pantalla-formulario" class="hidden flex-1 flex flex-col animate-in slide-in-from-right duration-300">
            <div class="p-6 pb-2 flex justify-between items-center bg-white/80 backdrop-blur-md sticky top-0 z-20">
                <button onclick="regresarInicio()" class="text-slate-400">‚Üê Volver</button>
                <h2 id="titulo-modo" class="text-xs font-black uppercase tracking-[0.2em] text-red-600">MODO: AHORA</h2>
                <div class="w-10"></div>
            </div>

            <div class="px-6 mb-4">
                <div id="map" class="h-44 rounded-[2.5rem] border-4 border-slate-50 overflow-hidden shadow-inner"></div>
            </div>

            <div class="px-6 space-y-4 pb-32">
                <div id="campo-fecha" class="hidden bg-blue-50 p-5 rounded-[2rem] border border-blue-100 space-y-3">
                    <p class="font-black text-[10px] text-blue-600 uppercase tracking-widest text-center">Fecha de Entrega</p>
                    <input type="datetime-local" id="f-fecha" class="w-full bg-white p-3 rounded-xl border-2 border-blue-100 font-bold text-slate-700 outline-none">
                </div>

                <div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-dom" class="w-6 h-6 rounded-lg accent-red-600">
                        <label for="check-dom" class="font-black uppercase text-xs tracking-widest text-slate-400">Gas Dom√©stico</label>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div><p class="text-[9px] font-bold text-yellow-600">AMARILLO</p><input type="number" id="cd-ama" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                        <div><p class="text-[9px] font-bold text-blue-600">AZUL</p><input type="number" id="cd-azu" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                        <div><p class="text-[9px] font-bold text-orange-600">NARANJA</p><input type="number" id="cd-nar" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                    </div>
                </div>

                <div class="bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                    <div class="flex items-center gap-3 mb-4">
                        <input type="checkbox" id="check-ind" class="w-6 h-6 rounded-lg accent-red-600">
                        <label for="check-ind" class="font-black uppercase text-xs tracking-widest text-slate-400">Gas Industrial</label>
                    </div>
                    <div class="grid grid-cols-3 gap-3 text-center">
                        <div><p class="text-[9px] font-bold text-yellow-600">AMARILLO</p><input type="number" id="ci-ama" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                        <div><p class="text-[9px] font-bold text-blue-600">AZUL</p><input type="number" id="ci-azu" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                        <div><p class="text-[9px] font-bold text-orange-600">NARANJA</p><input type="number" id="ci-nar" value="0" onfocus="if(this.value=='0')this.value=''" class="w-full bg-white border-2 border-slate-200 rounded-xl p-2 font-bold text-center"></div>
                    </div>
                </div>

                <div class="flex justify-between items-center bg-red-50 p-5 rounded-[2rem] border border-red-100">
                    <span class="font-black text-red-600 text-xs uppercase tracking-widest">üí∞ Propina</span>
                    <input type="number" id="f-propina" value="0" onfocus="if(this.value=='0')this.value=''" class="w-20 bg-white border-2 border-red-200 rounded-xl p-2 text-center font-black text-red-600">
                </div>
            </div>

            <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-white via-white to-transparent z-30">
                <button id="btn-main" onclick="realizarPedido()" class="w-full p-6 rounded-[2.5rem] font-black text-xl bg-red-600 text-white shadow-2xl shadow-red-200 active:scale-95 transition-all">
                    CONFIRMAR PEDIDO
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWGkvNQHt7URcoP2risWMBfYtdV1Un7Sk",
            authDomain: "gassolucion.firebaseapp.com",
            projectId: "gassolucion",
            storageBucket: "gassolucion.firebasestorage.app",
            messagingSenderId: "948928136223",
            appId: "1:948928136223:web:06bb3d6bf8054c1be0c12a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, marker, userGlobal = null;
        let modoActual = "ahora";

        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = "index.html";
            else {
                userGlobal = user;
                document.getElementById('u-nombre-inicio').innerText = user.displayName ? user.displayName.split(' ')[0] : "Amigo";
                escucharPedidos();
            }
        });

        // --- NAVEGACI√ìN ---
        window.irAFormulario = (modo) => {
            modoActual = modo;
            document.getElementById('pantalla-inicio').classList.add('hidden');
            document.getElementById('pantalla-formulario').classList.remove('hidden');
            document.getElementById('titulo-modo').innerText = modo === 'ahora' ? "Modo: Entrega Inmediata" : "Modo: Planificar Compra";
            document.getElementById('campo-fecha').classList.toggle('hidden', modo === 'ahora');
            
            setTimeout(() => { initMap(); }, 300); // Peque√±o delay para que el mapa cargue bien
        };

        window.regresarInicio = () => {
            document.getElementById('pantalla-inicio').classList.remove('hidden');
            document.getElementById('pantalla-formulario').classList.add('hidden');
        };

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([-0.1807, -78.4678], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            marker = L.marker([-0.1807, -78.4678], {draggable: true}).addTo(map);

            map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
            map.on('locationfound', (e) => marker.setLatLng(e.latlng));
        }

        window.realizarPedido = async function() {
            const btn = document.getElementById('btn-main');
            const pos = marker.getLatLng();
            
            btn.disabled = true;
            btn.innerText = "PROCESANDO...";

            let calle = "Ubicaci√≥n GPS", sector = "Llano Chico";
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.lat}&lon=${pos.lng}`);
                const data = await res.json();
                calle = (data.display_name.split(',')[0] || "Calle S/N");
                sector = data.address.suburb || data.address.neighbourhood || "Llano Chico";
            } catch (e) { console.error(e); }

            const pedido = {
                uidC: userGlobal.uid,
                nombre: userGlobal.displayName,
                lat: pos.lat,
                lng: pos.lng,
                direccion: calle,
                sector: sector,
                propina: document.getElementById('f-propina').value || 0,
                estado: 'pendiente',
                modo: modoActual,
                fechaPlanificada: modoActual === 'planificado' ? document.getElementById('f-fecha').value : 'inmediato',
                fechaCreacion: new Date().toISOString(),
                items: []
            };

            const config = [
                {id: 'cd-ama', t: 'Dom√©stico', c: 'Amarillo', chk: 'check-dom'},
                {id: 'cd-azu', t: 'Dom√©stico', c: 'Azul', chk: 'check-dom'},
                {id: 'cd-nar', t: 'Dom√©stico', c: 'Naranja', chk: 'check-dom'},
                {id: 'ci-ama', t: 'Industrial', c: 'Amarillo', chk: 'check-ind'},
                {id: 'ci-azu', t: 'Industrial', c: 'Azul', chk: 'check-ind'},
                {id: 'ci-nar', t: 'Industrial', c: 'Naranja', chk: 'check-ind'}
            ];

            config.forEach(item => {
                const cant = parseInt(document.getElementById(item.id).value);
                if (cant > 0 && document.getElementById(item.chk).checked) {
                    pedido.items.push({ n: cant, t: item.t, c: item.c });
                }
            });

            if (pedido.items.length === 0) {
                alert("Selecciona al menos un tanque y marca la casilla.");
                btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO";
                return;
            }

            if (modoActual === 'planificado' && !document.getElementById('f-fecha').value) {
                alert("Por favor elige fecha y hora para tu entrega.");
                btn.disabled = false; btn.innerText = "CONFIRMAR PEDIDO";
                return;
            }

            try {
                await addDoc(collection(db, "pedidos"), pedido);
                alert("üöÄ Pedido realizado con √©xito.");
                regresarInicio();
            } catch (e) { alert(e.message); btn.disabled = false; }
        };

        function escucharPedidos() {
            const q = query(collection(db, "pedidos"), where("uidC", "==", auth.currentUser.uid));
            onSnapshot(q, snap => {
                const btn = document.getElementById('btn-main');
                // Aqu√≠ podr√≠as a√±adir un aviso visual en la pantalla de inicio si ya hay un pedido activo
            });
        }

        window.cerrarSesion = () => signOut(auth).then(() => window.location.href = "index.html");

    </script>
</body>
</html>
