<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasSoluci칩n | Bienvenida</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">

    <div id="app" class="bg-white p-8 rounded-3xl shadow-xl w-full max-w-md text-center">
        <h1 class="text-3xl font-bold text-red-600 mb-2">GasSoluci칩n 游쀯릖</h1>
        <p class="text-slate-500 mb-8">Tu gas a un clic, seguro y r치pido.</p>

        <div id="view-login">
            <button id="btn-google" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-300 p-4 rounded-xl font-semibold hover:bg-slate-50 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" width="20">
                Entrar con Google
            </button>
        </div>

        <div id="view-role" class="hidden">
            <h2 class="text-xl font-semibold mb-4">쮺칩mo usar치s la App?</h2>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="setRole('cliente')" class="p-6 border-2 border-red-100 rounded-2xl hover:border-red-500 transition group">
                    <span class="text-4xl block mb-2">游</span>
                    <span class="font-bold text-slate-700">Cliente</span>
                </button>
                <button onclick="setRole('proveedor')" class="p-6 border-2 border-red-100 rounded-2xl hover:border-red-500 transition group">
                    <span class="text-4xl block mb-2">游뚵</span>
                    <span class="font-bold text-slate-700">Proveedor</span>
                </button>
            </div>
        </div>

        <div id="view-loading" class="hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
            <p class="mt-4 text-slate-600">Configurando tu perfil...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWGkvNQHt7URcoP2risWMBfYtdV1Un7Sk",
            authDomain: "gassolucion.firebaseapp.com",
            projectId: "gassolucion",
            storageBucket: "gassolucion.firebasestorage.app",
            messagingSenderId: "948928136223",
            appId: "1:948928136223:web:06bb3d6bf8054c1be0c12a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;

        // L칩gica de Login
        document.getElementById('btn-google').onclick = async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                checkUser(result.user);
            } catch (error) {
                alert("Error al entrar con Google");
            }
        };

        async function checkUser(user) {
            showView('view-loading');
            const userRef = doc(db, "usuarios", user.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                redirectUser(userSnap.data());
            } else {
                currentUser = user;
                showView('view-role');
            }
        }

        window.setRole = async (rol) => {
            showView('view-loading');
            
            // Generar ID 칔nico (Ej: CLN-4829 o PRV-9283)
            const randomID = Math.floor(1000 + Math.random() * 9000);
            const customID = rol === 'cliente' ? `CLN-${randomID}` : `PRV-${randomID}`;

            const userData = {
                uid: currentUser.uid,
                nombre: currentUser.displayName,
                email: currentUser.email,
                foto: currentUser.photoURL,
                rol: rol,
                appID: customID,
                fechaRegistro: new Date().toISOString(),
                saldo: 0
            };

            await setDoc(doc(db, "usuarios", currentUser.uid), userData);
            redirectUser(userData);
        };

        function redirectUser(data) {
            // Guardar localmente para no repetir login
            localStorage.setItem('gs_user', JSON.stringify(data));
            
            if(data.rol === 'cliente') {
                alert("Bienvenido " + data.nombre + " (ID: " + data.appID + "). Fase 2 en camino...");
                // Aqu칤 ir치 el link a la fase 2
            } else {
                alert("Bienvenido Proveedor (ID: " + data.appID + "). Fase 3 en camino...");
            }
        }

        function showView(viewId) {
            ['view-login', 'view-role', 'view-loading'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
        }
    </script>
</body>
</html>
