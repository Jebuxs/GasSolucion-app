<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GasSoluci贸n | Bienvenida</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="max-w-md w-full bg-white p-8 rounded-[2.5rem] shadow-2xl text-center">
        <h1 class="text-5xl font-black text-slate-900 tracking-tighter">Gas<span class="text-red-600">Soluci贸n</span></h1>
        <p class="text-slate-400 mt-2 font-medium">Inicia sesi贸n para continuar</p>
        
        <div id="loading" class="mt-10">
            <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-red-600 mx-auto"></div>
        </div>

        <button id="btn-login" class="hidden w-full mt-10 bg-slate-900 text-white p-5 rounded-3xl flex items-center justify-center gap-4 font-bold shadow-xl active:scale-95 transition-all">
            <img src="https://www.google.com/favicon.ico" class="w-6 h-6 brightness-200"> Entrar con Google
        </button>

        <div id="role-selection" class="hidden mt-10 space-y-4">
            <h2 class="text-xl font-black">驴C贸mo usar谩s la app?</h2>
            <button onclick="registrarRol('cliente')" class="w-full bg-white border-2 p-6 rounded-2xl font-bold text-left hover:border-red-500"> Soy Cliente</button>
            <button onclick="registrarRol('proveedor')" class="w-full bg-white border-2 p-6 rounded-2xl font-bold text-left hover:border-slate-900 text-red-600"> Soy Proveedor</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWGkvNQHt7URcoP2risWMBfYtdV1Un7Sk",
            authDomain: "gassolucion.firebaseapp.com",
            projectId: "gassolucion",
            storageBucket: "gassolucion.firebasestorage.app",
            messagingSenderId: "948928136223",
            appId: "1:948928136223:web:06bb3d6bf8054c1be0c12a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "usuarios", user.uid));
                if (snap.exists()) {
                    const rol = snap.data().rol;
                    // REDIRECCIN SEGN ROL
                    window.location.href = rol + ".html"; 
                } else {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('role-selection').classList.remove('hidden');
                }
            } else {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('btn-login').classList.remove('hidden');
            }
        });

        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);

        window.registrarRol = async (rol) => {
            const user = auth.currentUser;
            const appID = (rol === 'cliente' ? 'CLN-' : 'PRV-') + Math.floor(1000 + Math.random() * 9000);
            await setDoc(doc(db, "usuarios", user.uid), {
                nombre: user.displayName, foto: user.photoURL, email: user.email,
                rol: rol, appID: appID, fecha: new Date().toISOString()
            });
            window.location.href = rol + ".html";
        };
    </script>
</body>
</html>
